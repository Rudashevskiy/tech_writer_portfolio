

Руководство администратора
===========================

Введение
--------

Документ содержит информацию, необходимую для освоения работы программного пакета ArhiPlex 2.0 (далее -- Система) в качестве системного администратора,
технологического администратора системы, а также всех иных существующих административных ролях системы.


Задачи и функции администрирования при эксплуатации Системы
-----------------------------------------------------------

Основными задачами администратора являются: управление Системой и мониторинг состояния Системы.

Для решения этих задач системный администратор должен обладать следующими навыками:

- администрирования операционной системы Linux

Основные функции: 

- Установка и сопровождение Системы 
- Сбор статистики, мониторинга, диагностики Системы
- Обеспечение бесперебойного функционирования ОС и прикладных программ для функционирования Системы

Описание Системы
----------------

Программное обеспечение устанавливается в изолированном контуре на выделенных мощностях с ОС Linux.

В состав Системы входит следующий перечень компонентов:

- Программный пакет ArhiPlex 2.0 -- Солвер  
- Программный пакет, содержащий license-server -- Сервер Лицензирования
- Программные интерфейсы для доступа из Python (пакет Arhiplexpy)

Программное обеспечение работает по следующему принципу:

В рамках целевой информационной системы имеется вычислительный модуль, который осуществляет построение 
математической модели на основе данных из информационной системы, 
отправку математической модели с использованием SDK (Software Development Kit) в Солвер 
для последующего решения и получения результата для последующей обработки.

Вычислительный модуль обращается к Солверу, который установлен на тех же вычислительных ресурсах, 
что и сам модуль.

Клиент-серверного взаимодействия между вычислительным модулем и Солвером не предполагается.
   
Солвер подключается к Серверу Лицензирования через HTTPS. 
Авторизация происходит с использованием технической доменной учётной записи по сетевому протоколу аутентификации Kerberos

Солвер отправляет запросы на Сервер Лицензирования в начале и в конце расчёта. Перед началом расчёта осуществляется проверка лицензии. 
Если ограничений нет, расчёт выполняется. Если один из параметров лицензии превышен, выдаётся предупреждение о работе 
с лицензией, расчёт ограничивается одной минутой.

Лицензии ArhiPlex 2.0 работают на основе исчерпаемого ресурса (количество параллельных расчётов) и времени действия.


Инсталляция и подготовка Системы к эксплуатации
-----------------------------------------------

Для установки и корректной работы программного решения Системы рекомендуется выделение мощностей под работу Солвера со следующими характеристиками:

- 24 CPU и более
- 256GB RAM и более
- 50 GB SSD и более

Для развертывания и функционирования Системы необходимо наличие серверов, минимальные требования.

.. csv-table:: Параметры сервера
    :header: "**№**", "**Назначение**", "**Процессор**", "**Оперативная память**", "**Дисковое пространство**", "**Количество**", "**Программная среда**"
    :name: minserver

    "1", "Сервер приложений 1 (Сервер Лицензирования)", "2 CPU", "4 Gb ", "10 Gb ", "1", "Ubuntu (20.04, 22.04), Debian (10, 11, 12), Astra Linux (1.7), RHEL (8), Redos (7.3)"
    "2", "Сервер приложений 2 (Сервер Расчёта)", "24 CPU", "256 Gb ", "50 Gb ", "1", "Ubuntu (20.04, 22.04), Debian (10, 11, 12), Astra Linux (1.7), RHEL (8), Redos (7.3)"


.. _preinstall:

========================
Подготовка к инсталляции
========================

Для установки Системы будут переданы следующие файлы:

- linux-x64-licensed-arhiplex-<version>.tar.gz
- arhiplex-license-server.tar.gz

В качестве операционной системы для Серверов приложений используется Linux.

Перед установкой администратору домена необходимо:

1. Создать техническую доменную учетную запись для авторизации Солвера на Сервере Лицензирования  

2. Подготовить виртуальную машину

3. Создать A-запись в DNS

4. Создать keytab с SPN: HTTP/<FQDN хоста>

5. Выпустить TLS сертификат для HTTPS

===========================
Инсталляция системы
===========================

+++++++++++++++++++++++++++++++++++++++++++++++
Установка программного обеспечения ArhiPlex 2.0
+++++++++++++++++++++++++++++++++++++++++++++++

На текущий момент поддерживается Ubuntu (20.04, 22.04), Debian (10, 11, 12), Astra Linux (1.7), RHEL (8), Redos (7.3).

1. Для установки необходимо распаковать архив в любую папку:

.. code-block:: bash

    tar -xzvf ARHIPLEX-<version>-Linux.tar.gz

2. После распаковки появится папка ARHIPLEX-<version>-Linux. Её можно перенести в любое удобное
место, например в /opt:

.. code-block:: bash

    sudo mv ARHIPLEX-<version>-Linux /opt/

3. Далее необходимо установить необходимые переменные окружения. Для этого необходимо добавить
в файл .bashrc в вашей ${HOME} папке следующие строки:

.. code-block:: bash

    export ARHIPLEX_HOME=/opt/ARHIPLEX-<version>-Linux
    export PATH=${ARHIPLEX_HOME}/bin:${PATH}
    export LD_LIBRARY_PATH=${ARHIPLEX_HOME}/lib64:${LD_LIBRARY_PATH}

4. После добавления нужно открыть новый терминал и проверить:

.. code-block:: bash
    
    echo ${ARHIPLEX_HOME}
    echo ${PATH}
    echo ${LD_LIBRARY_PATH}

5. Для того чтобы установить Python API необходимо сменить директорию и выполнить команду:

.. code-block:: bash

    cd lib64/python
    pip3 install .

Настройка Kerberos-аутентификации ArhiPlex 2.0 описана в разделе :ref:`setup`

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Установка программного обеспечения сервера приложений 1 (Сервер Лицензирования)
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Для установки необходимо:

1. На виртуальной машине создать пользователя license-server
воспользуйтесь командой useradd [Имя пользователя], пример:

.. code-block:: bash

    useradd license-server

Эта команда автоматически создаст нового пользователя, однако у него не будет ни группы, ни домашней директории, ни пароля. Для основных настроек вам могут потребоваться следующие ключи:

-d - Указывает домашнюю директорию пользователя. Если ее не существует, то она не будет создана.

-G - Указывает группы, в которые должен входить новый пользователь.

-m - Создает домашнюю директорию.

-s - Указывает оболочку. По умолчанию используется sh.

2. Создать директорию /opt/license-server. Скопировать исполняемый файл license-server в /opt/license-server/license-server, добавить права на запуск (+x):

.. code-block:: bash

    $ mkdir /opt/license-server
    $ cp <путь_к_исполняемому_файлу> /opt/license-server/license-server
    $ chmod +x /opt/license-server/license-server

3. Скопировать keytab в /opt/license-server/krb5.keytab

.. code-block:: bash

    cp <путь_к_кейтаб> /opt/license-server/krb5.keytab

4. Создать директорию /opt/license-server/keys

.. code-block:: bash

    mkdir /opt/license-server/keys

a) Скопировать в директорию ключи:

   - rootCA.crt
   - server.crt
   - server.key

.. note:: 
    
    TLS сертификат для HTTPS из prerequisites. П.5 Выпуск TLS сертификат для HTTPS (см :ref:`preinstall`). 


5. Выполнить

.. code-block:: bash

    chown -R license-server /opt/license-server

6. Скорректировать переменную среды OS_USER в файле license-server.service

  Environment="KRB5_KTNAME=krb5.keytab" "OS_USER=service@DEV.COM"

.. code-block::
    :emphasize-lines: 10

    [Unit]
    Description=solver license server
    After=network-online.target local-fs.target time-sync.target
    Wants=network-online.target local-fs.target time-sync.target
    
    [Service]
    User=license-server
    Type=exec
    WorkingDirectory=/opt/license-server
    Environment="KRB5_KTNAME=krb5.keytab" "OS_USER=service@DEV.COM"
    ExecStart=/opt/license-server/license-server
    Restart=always
    RestartSec=30s
    TimeoutSec=30
 
    [Install]
    WantedBy=multi-user.target


7. Скопировать файл license-server.service в /etc/systemd/system/license-server.service и выполнить:

.. code-block:: bash

    systemctl daemon-reload

.. code-block:: bash
    
    systemctl enable license-server.service

.. code-block:: bash
    
    systemctl start license-server.service

.. _setup:

++++++++++++++++++++++++++++++++++++++++++++++
Настройка подключения к Серверу Лицензирования
++++++++++++++++++++++++++++++++++++++++++++++

Для успешной работы и осуществления вычислений требуется подключение каждого установленного экземпляра Солвера к Серверу Лицензирования. 
Требуется настроить Kerberos-аутентификацию ArhiPlex 2.0.
Основные настройки прописаны в файле конфигурации config.toml. Конфигурационный файл расположен в папке ARHIPLEX_HOME и содержит следующие настройки:

.. code-block::

    USER = "service"
    REALM = "DEV.TR-SUPPORT.RU"
    PASSWORD = "*****"
    SERVER = "localhost"
    PORT = "8443"
    CACERT = "/opt/arhiplex/rootCA.crt"
    KRB5_CONF = "/etc/krb5.conf"

В конфигурационном файле необходимо задать следующие параметры:

- USER: «service» — задать имя доменного пользователя, под которым будет осуществляться аутентификация Солвера на Сервере Лицензирования (техническая учетная запись п.1 :ref:`preinstall`);
- REALM: «DEV.TR-SUPPORT.RU» — прописать актуальный домен Kerberos, в котором будет происходить аутентификация;
- PASSWORD: «********» — задать пароль пользователя;
- SERVER: «localhost» — указать адрес (имя) адрес Сервера Лицензирования (FQDN);
- CACERT: «/opt/arhiplex/rootCA.crt» — указать путь к сертификату корневого центра сертификации, который будет использоваться для проверки TLS сертификата сервиса лицензирования;
- KRB5_CONF: «/etc/krb5.conf» — указать путь к файлу конфигурации Kerberos.

Активация лицензии
-------------------------------

Лицензии ArhiPlex 2.0 активируются на Сервере Лицензирования и привязываются к аппаратному обеспечению сервера и FQDN (Fully Qualified Domain Name). 
При изменении параметров, лицензии блокируются.

Для активации лицензии Солвера:

1. Отправить uid Сервера Лицензирования на электронный адрес разработчика ArhiPlex 2.0

- запустить Arhiplex license server UI (пользовательский интерфейс Сервера Лицензирования ArhiPlex, далее -- UI), открыть в браузере и ввести адрес хоста https:\\<адрес>:8443;
- скопировать Server uid из UI;
- выслать Server uid на электронный адрес поставщика продукта (info@arhitexlab.ru).

1. Получить от разработчика лицензию и активировать через UI

- скопируйте данные лицензии, которые будут направлены в ответ на ваше письмо об Server uid;
- вставить в поле «Activate license» данные лицензии и активировать нажав кнопку «ACTIVATE».


С помощью UI можно узнать статус активных лицензий ArhiPlex 2.0 и получить список последних расчётов.

Запуск и остановка Системы
--------------------------

=================
Запуск Системы
=================

Сервис license-server включен в автозагрузку. Сервис запускается автоматически при старте Системы.

Если по каким то причинам автозапуска не было, выполнить повторно команду:

.. code-block:: bash

    systemctl start license-server.service


==================
Остановка Системы 
==================

Для остановка Системы выполните команду:

.. code-block:: bash

    systemctl stop license-server.service

Мониторинг Системы
------------------

Сервер Лицензирования предоставляет метрики в формате Prometheus по адресу /metrics

Сервер пишет log systemd (настройка выполняется стандартными средствами). 

Для отображения логов Сервера Лицензирования выполните команду:

.. code-block:: bash

    journalctl -u license-server

Сопровождение
-------------

==================================================
Установка новых версий серверного прикладного ПО
==================================================

Установка новых версий ArhiPlex 2.0 осуществляется в соответствии с инструкцией к релизу поставки.

Установка новых версий Сервиса Лицензирования осуществляется следующим порядком:

1) получить обновление от поставщика

2) остановить Сервер Лицензирования license-server 

3) заменить исполняемый файл в /opt/license-server/license-server:

.. code-block:: bash

    $ chmod +x /opt/license-server/license-server
    $ chown -R license-server /opt/license-server

4) запустить Сервер Лицензирования license-server


==================================================
Восстановление Системы после разрушения
==================================================

Не допускается простой (отключение) Сервера Лицензирования больше чем на 48 часов в месяц. В случае большего времени простоя, лицензии блокируются.

Таким образом, требуемое время восстановления серверного ПО должно быть в течение 48 часов с момента выхода из строя технических средств или сбоев системных программных средств.
